<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello Electron</title>
    <!-- <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' https://cdn.jsdelivr.net ;
      script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
      style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
      img-src 'self' data: http://192.168.20.42:4747;
      media-src http://192.168.20.42:4747;
    "> -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>



    <script>
      async function ipcTimeNow(params) {
        const r = await window.electronAPI.timeNow();
        console.log(r); // { name: "Electron", version: "1.0" }
        alert(r);
      } 
      async function ipcQuit(params) {
        alert('종료합니다.')
        const r = await window.electronAPI.quit();
      } 
      async function ipcToggleFullscreen(params) {
        const r = await window.electronAPI.toggleFullscreen();
      } 
    </script>
    <script>
      let stream =null;
      async function startWebcam(){
        const video = document.querySelector('#webcam');
        stream = await navigator.mediaDevices.getUserMedia({ video: {width: 1280, height: 720} , audio: true });
        video.srcObject = stream;
        await video.play();
      }
      async function stopWebcam(){
        if(stream){
          const video = document.querySelector('#webcam');
          stream.getTracks().forEach(track => track.stop());
          video.srcObject = null;
        }
      }
      function captureWebcam(){
        const snapshot = document.querySelector('#snapshot');
        const webcam = document.querySelector('#webcam');
        const canvas = document.createElement('canvas');
        canvas.width = webcam.width;
        canvas.height = webcam.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);

        // 캡처 이미지를 <img>에 표시
        snapshot.src = canvas.toDataURL('image/png');
      }
      const prevCanvas = document.createElement('canvas');
      let requestAnimationFrameId = null;
      function captureDiffWebcam(){
        const diffshot = document.querySelector('#diffshot');
        const video = document.querySelector('#webcam');
        const currentCanvas = document.createElement('canvas');
        currentCanvas.width = video.videoWidth;
        currentCanvas.height = video.videoHeight;
        const ctx = currentCanvas.getContext('2d');
        ctx.drawImage(video, 0, 0, currentCanvas.width, currentCanvas.height);


        const diffCanvas = document.querySelector('#diffCanvas');
        diffCanvas.width = video.videoWidth;
        diffCanvas.height = video.videoHeight;
        {
          const ctx = diffCanvas.getContext('2d');
          ctx.drawImage(currentCanvas, 0, 0, currentCanvas.width, currentCanvas.height);
          ctx.globalCompositeOperation="difference";
          ctx.drawImage(prevCanvas, 0, 0, prevCanvas.width, prevCanvas.height);
        }
        
        
        {
          const ctx = prevCanvas.getContext('2d');
          prevCanvas.width = currentCanvas.width;
          prevCanvas.height = currentCanvas.height;
          ctx.drawImage(currentCanvas, 0, 0, currentCanvas.width, currentCanvas.height);
        }
        
        requestAnimationFrameId = requestAnimationFrame(captureDiffWebcam);
      }
      function stopCaptureDiffWebcam(){
        cancelAnimationFrame(requestAnimationFrameId);
      }
    </script>
  </head>
  <body>
    <div class="container">
        <div class="h-100">
          <div>
            <h1>Hello Electron Sample App</h1>
            <div class="card my-3">
              <div class="card-header">Buttons</div>
              <div class="card-body">
                <div class="">
                  <button type="button" class="btn btn-primary" onclick="ipcTimeNow()">ipcTimeNow</button>
                  <button type="button" class="btn btn-primary" onclick="ipcToggleFullscreen()">ipcToggleFullscreen()</button>
                  <button type="button" class="btn btn-danger" onclick="ipcQuit()">ipcQuit</button>
                  <button type="button" class="btn btn-danger" onclick="self.close()">self.close()</button>
                  <button type="button" class="btn btn-primary" onclick=" window.electronAPI.load_index_html(); ">load_index_html()</button>
                  <button type="button" class="btn btn-primary" onclick=" window.electronAPI.load_network_video_html().then(()=>{}).catch((e)=>{console.log(e);});">load_network_video_html()</button>
                  <a type="button" class="btn btn-primary" href="./index.html">index.html</a>
                  <a type="button" class="btn btn-primary" href="./network-video.html">network-video.html</a>
                </div>
              </div>
            </div>
            <div class="card my-3">
              <div class="card-header">WEBCAM</div>
              <div class="card-body">
                <div class="mb-3 d-flex flex-wrap gap-3">
                  <div>
                    <div class="form-label">webcam</div>
                    <div>
                      <!-- <video id="webcam" src="http://192.168.20.42:4747/video" autoplay playsinline muted controls style="display: block; aspect-ratio: 16/9; width: 300px;"></video> -->
                       <img id="webcam" width="640" height="480" src="http://192.168.20.134:34747/video?640x480" crossorigin="anonymous">
                    </div>
                  </div>
                  <div>
                    <div class="form-label">capture</div>
                    <div>
                      <img id="snapshot" src="" alt="" width="300">
                    </div>
                    <div>
                      <a href="" download="download.png" onclick="this.href = document.querySelector('#snapshot').src">다운로드</a>
                    </div>
                  </div>
                  <div>
                    <div>
                      <div class="form-label">diff(motion detect)</div>
                      <canvas id="diffCanvas" style="width:300px;filter: invert(1) grayscale(1);"></canvas>
                    </div>
                  </div>
                </div>
                <div class="">
                  <button type="button" class="btn btn-primary" onclick="startWebcam()">startWebcam()</button>
                  <button type="button" class="btn btn-primary" onclick="stopWebcam()">stopWebcam()</button>
                  <button type="button" class="btn btn-primary" onclick="captureWebcam()">captureWebcam()</button>
                  <button type="button" class="btn btn-primary" onclick="captureDiffWebcam()">captureDiffWebcam()</button>
                  <button type="button" class="btn btn-primary" onclick="stopCaptureDiffWebcam()">stopCaptureDiffWebcam()</button>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </body>
</html>